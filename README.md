# SV-pipeline

SV-pipeline is a modular and automated framework for structural variant (SV) detection, filtering,
merging, and post-analysis using third-generation sequencing data. The pipeline integrates multiple
state-of-the-art SV calling strategies and provides standardized post-processing procedures to
generate high-confidence SV datasets suitable for downstream pangenome and population genomics
analyses.

Based on the comprehensive benchmarking study of Liu et al. (2024), four optimal combinations were
selected for HiFi read–based SV calling:

- pbmm2 + cuteSV2
- minimap2 + Sniffles2
- ngmlr + SVIM
- Winnowmap + pbsv

In addition, two assembly-based approaches are included to improve sensitivity for complex structural
rearrangements:

- minimap2 + SVIM-asm
- nucmer + SyRI


## Workflow

SV-pipeline consists of two major stages:

1. Multi-strategy SV calling based on HiFi reads and genome assemblies
2. Post-calling filtering, merging, and summary analysis

The overall workflow of SV-pipeline is illustrated below:

![SV Pipeline Flowchart](pictures/SV-pipline.png)

## Installation

```bash
# Clone the repository
git clone https://github.com/Santiana123/SV-pipline.git
cd SV-pipline

# Create a conda environment using the provided YAML file
conda env create -f Installation/SV-pipline.yaml

# Activate the environment
conda activate SV
```

## Usage on HPC

SV-pipeline is designed for high-performance computing (HPC) environments.
The job submission script (`SV-pipline.sh`) includes typical PBS directives:

```bash
#PBS -j oe                 # merge stdout and stderr
#PBS -q queue_name         # queue name
#PBS -V                    # export environment variables
#PBS -l nodes=1:ppn=40     # resources: 1 node, 40 CPU cores
```

Before submission, edit **SV-pipline.sh** to specify input parameters:

```bash
name=sample1
ref=/path/to/reference.fasta
query=/path/to/query.fasta
reads=/path/to/sample1.fastq.gz
```

Other variables:

- `threads=40` → number of CPU threads  


## SV Calling

```bash
qsub SV-pipline.sh
```

SV calls generated by each strategy will be written to separate directories:

- `1.pbmm2-cutesv2/`  
- `2.minimap2-sniffles2/`  
- `3.ngmlr-svim/`  
- `4.winnowmap-pbsv/`  
- `5.minimap2-SVIM-asm/`
- `6.nucmer-SyRI/`
- `7.merge/`

Each directory contains alignment files, raw SV calls, and log files produced by the corresponding
pipeline.

## SV Filtering and Merging

SV-pipeline provides an optional post-calling filtering and merging module to reduce false positives
and improve result consistency.

### Filtering individual SV callsets
SV calls from different callers are filtered based on read depth (DP) using user-defined thresholds.
Dedicated filtering scripts are implemented for each caller.

Example:

```bash
bash SV-filter/SV-filter-pipeline.sh 9 71
```
### Merging and post-processing
Filtered SV callsets are merged using SURVIVOR to generate a consensus SV dataset.
Assembly-based SVs (SyRI and SVIM-asm) are included to improve detection of complex structural
rearrangements.

Post-processing steps include:

- extraction of inversion (INV) breakpoints
- refinement of breakend (BND) representations
- summary statistics of SV number and length distributions
- extraction of duplication (DUP) regions


## Output files
Typical outputs include:

- **BAM files** → aligned reads (`*.bam`, `*.bam.bai`)  
- **VCF files** → structural variant calls (`*.vcf`, `*.vcf.gz`)  
- **Log files** → runtime logs from each step (`*.log`)  
- **Intermediate index files** → mapping indexes (`*.mmi`, `*.fai`)
- **Merged VCF** → high-confidence SV set (merge.filtered.vcf)
- **Statistics files** → SV counts and length distributions

Each pipeline directory is self-contained and can be inspected independently.

## Notes

The SV-filter module is designed for structural variant post-processing. For software usage details, refer to their official documentation.
The DeepVariant-filter directory provides auxiliary scripts for SNP/INDEL filtering and is independent of the SV pipeline. See the corresponding software docs for parameter settings and troubleshooting.


## Citation

If you use this pipeline, please cite the benchmarking study:

Liu Z, Xie Z, Li M. Comprehensive and deep evaluation of structural variation detection pipelines with third-generation sequencing data[J]. Genome Biology, 2024, 25(1): 188.
